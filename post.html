<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H4CK3R FIRST - Post</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <header>
      <h1><a href="index.html">./h4ck3rfirst</a><span class="blink">_</span></h1>
    </header>
    <nav><a href="index.html">← Back to Posts</a></nav>
    <article id="post-content" class="post">
      <div class="loading">Loading post<span class="dots">...</span></div>
      <div id="error-message" class="error" style="display:none;">Error loading post. Check console (F12) for details.</div>
    </article>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked-highlight@2.0.7/lib/index.umd.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    marked.use(markedHighlight({
      highlight: (code, lang) => hljs.getLanguage(lang) ? hljs.highlight(code, {language: lang}).value : hljs.highlightAuto(code).value
    }));

    const params = new URLSearchParams(location.search);
    const file = params.get('p') || 'posts/default.md';
    const contentEl = document.getElementById('post-content');
    const errorEl = document.getElementById('error-message');

    console.log('Attempting to load file:', file); // Debug log

    // Fetch with retry + better error handling
    function loadPost(attempt = 1) {
      fetch(file)
        .then(r => {
          if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText} (File may not exist or path wrong)`);
          }
          return r.text();
        })
        .then(md => {
          console.log('File loaded successfully:', file); // Debug
          contentEl.innerHTML = marked.parse(md);
          document.title = "H4CK3R FIRST - " + (md.match(/^#\s+(.+)/)?.[1] || file.split('/').pop().replace('.md', ''));
          hljs.highlightAll();
          contentEl.classList.remove('loading'); // Hide loading
        })
        .catch(err => {
          console.error('Fetch error for', file, ':', err); // Log to console
          if (attempt < 2) {
            console.log('Retrying fetch...');
            setTimeout(() => loadPost(attempt + 1), 1000); // Retry once after 1s
            return;
          }
          contentEl.style.display = 'none';
          errorEl.innerHTML = `
            <h2>Failed to Load Post</h2>
            <p><strong>File:</strong> <code>${file}</code></p>
            <p><strong>Error:</strong> ${err.message}</p>
            <p><em>Check: File exists in /posts/? Case-sensitive? Rebuild site?</em></p>
            <a href="index.html">← Back to Posts</a>
          `;
          errorEl.style.display = 'block';
        });
    }

    loadPost(); // Start loading
  </script>
</body>
</html>
