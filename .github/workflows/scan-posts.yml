name: Auto-Scan Posts + Tags + Categories

on:
  push:
    paths:
      - 'posts/**.md'

permissions:
  contents: write-all

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # important for rebase

      - name: Generate posts.json with tags & categories
        run: |
          python3 - <<'PY'
          import os, json, re, datetime
          try:
              import yaml
          except ImportError:
              import subprocess, sys
              subprocess.check_call([sys.executable, "-m", "pip", "install", "pyyaml"])
              import yaml

          posts = []
          posts_dir = 'posts'
          if not os.path.isdir(posts_dir):
              json.dump([], open('posts.json','w'))
              exit()

          for f in sorted(os.listdir(posts_dir), reverse=True):
              if not f.endswith('.md'): continue
              path = f"{posts_dir}/{f}"
              try:
                  content = open(path, encoding='utf-8').read()
              except:
                  continue

              lower = f.lower()
              category = 'notes'
              if any(x in lower for x in ['htb','hackthebox']): category = 'hackthebox'
              elif any(x in lower for x in ['thm','tryhackme']): category = 'tryhackme'
              elif 'vulnhub' in lower: category = 'vulnhub'
              elif 'report' in lower: category = 'reports'

              tags = []
              fm = re.search(r'^---\s*\n([\s\S]*?)\n---', content)
              if fm:
                  try:
                      data = yaml.safe_load(fm.group(1))
                      raw = data.get('tags', [])
                      if isinstance(raw, list):
                          tags = [str(t).strip() for t in raw]
                  except: pass

              title = re.search(r'^#\s+(.+)', content, re.M)
              title = title.group(1).strip() if title else f.rsplit('.',1)[0].replace('-',' ').title()

              date = re.search(r'(\d{4}-\d{2}-\d{2})', f)
              date = date.group(1) if date else datetime.date.today().isoformat()

              posts.append({"file":path,"title":title,"date":date,"category":category,"tags":tags})

          json.dump(posts, open('posts.json','w'), indent=2)
          PY

      - name: Commit & push posts.json if changed
        run: |
          git config user.name "Auto Scanner Bot"
          git config user.email "bot@h4ck3rfirst"
          git pull --rebase origin main
          git add posts.json
          if git diff --quiet --staged; then
            echo "No changes"
            exit 0
          fi
          git commit -m "Auto-update posts.json [skip ci]"
          git push origin main