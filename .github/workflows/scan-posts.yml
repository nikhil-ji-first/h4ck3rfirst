name: Auto-Scan Posts

on:
  push:
    paths:
      - 'posts/**.md'

permissions:
  contents: write
  actions: read

jobs:
  generate-manifest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate posts.json
        run: |
          python3 - <<'PY'
          import os, json, re, datetime
          posts = []
          posts_dir = 'posts'
          if os.path.exists(posts_dir):
              files = [f for f in os.listdir(posts_dir) if f.endswith('.md')]
              files.sort(reverse=True)  # Newest filename first
              for f in files:
                  path = f"{posts_dir}/{f}"
                  try:
                      with open(path, 'r', encoding='utf-8') as file:
                          content = file.read()
                      title_match = re.search(r'^#\s+(.+)', content, re.MULTILINE)
                      title = title_match.group(1).strip() if title_match else f.replace('.md', '').replace('-', ' ').title()
                      date_match = re.search(r'(\d{4}-\d{2}-\d{2})', f) or re.search(r'date:\s*(\d{4}-\d{2}-\d{2})', content, re.MULTILINE)
                      date = date_match.group(1) if date_match else datetime.date.today().isoformat()
                      excerpt_start = content.find('\n#') + 1 if content.find('\n#') > 0 else 0
                      excerpt = content[excerpt_start:excerpt_start + 100].strip() + '...' if excerpt_start else content[:100] + '...'
                      posts.append({"file": path, "title": title, "date": date, "excerpt": excerpt})
                  except Exception as e:
                      print(f"Skipped {f}: {e}")
          with open('posts.json', 'w') as f:
              json.dump(posts, f, indent=2)
          print(f"Generated {len(posts)} posts")
          PY

      - name: Commit if changed
        run: |
          git config user.name "Post Scanner Bot"
          git config user.email "bot@h4ck3rfirst"
          git add posts.json
          git diff --staged --quiet || (git commit -m "Auto-update posts.json [skip ci]" && git push)