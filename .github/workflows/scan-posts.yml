name: Auto-Scan Posts + Tags + Categories
on:
  push:
    paths: ['posts/**.md']

permissions: contents: write

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Generate posts.json with tags
        run: |
          python3 - <<'PY'
          import os, json, re, datetime, yaml
          posts = []
          for f in sorted(os.listdir('posts'), reverse=True):
              if not f.endswith('.md'): continue
              path = f"posts/{f}"
              content = open(path, 'r', encoding='utf-8').read()

              # Category from filename
              lower = f.lower()
              category = 'notes'
              if any(x in lower for x in ['htb','hackthebox']): category = 'hackthebox'
              elif any(x in lower for x in ['thm','tryhackme']): category = 'tryhackme'
              elif 'vulnhub' in lower: category = 'vulnhub'
              elif 'report' in lower: category = 'reports'

              # Extract frontmatter tags
              tags = []
              frontmatter = re.search(r'^---\s*\n(.*?)\n---', content, re.S)
              if frontmatter:
                  try:
                      data = yaml.safe_load(frontmatter.group(1))
                      tags = [t.strip() for t in data.get('tags', [])] if isinstance(data.get('tags'), list) else []
                  except: pass

              # Title & Date
              title = re.search(r'^#\s+(.+)', content, re.M)
              title = title.group(1).strip() if title else f.replace('.md','').replace('-',' ').title()
              date = re.search(r'(\d{4}-\d{2}-\d{2})', f)
              date = date.group(1) if date else datetime.date.today().isoformat()

              posts.append({
                  "file": path,
                  "title": title,
                  "date": date,
                  "category": category,
                  "tags": tags
              })
          json.dump(posts, open('posts.json', 'w'), indent=2)
          PY
      - name: Commit
        run: |
          git config user.name "Post Scanner"
          git add posts.json
          git diff --quiet --staged || (git commit -m "Update posts + tags [skip ci]" && git push)